open Syntax
module Cwe = Explode_js.Cwe
module Util = Yojson.Basic.Util

type t =
  { cwe : Cwe.t
  ; filename : Fpath.t
  ; lineno : string
  ; id : int
  }

let from_json json =
  let* cwe = Util.member "cwe" json |> Util.to_string |> Cwe.of_string in
  let filename = Util.member "filename" json |> Util.to_string |> Fpath.v in
  let* lineno =
    match Util.member "lineno" json with
    | `String x -> Ok x
    | `Int x -> Ok (string_of_int x)
    | _ -> Error (`Parsing "unknown lineno")
  in
  let id = Util.member "id" json |> Util.to_int in
  Ok { cwe; filename; lineno; id }

let pp_csv fmt { id; cwe; filename; _ } =
  Fmt.pf fmt "%d,%a,%a" id Cwe.pp cwe Fpath.pp filename
